<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="{{ url_for('static', filename='tree.css') }}"></link>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="{{ url_for('static', filename='tree.js') }}"></script>
  <script src="{{ url_for('static', filename='vis-network.min.js') }}"></script>
  <style type="text/css">
      #mynetwork {
        height: 850px;
        border: 1px solid lightgray;
      }
    </style>
</head>

<body>
<nav class="navbar navbar-light bg-light fixed-top">
  <a class="navbar-brand">Navbar</a>
  <form class="form-inline">
    <input class="form-control mr-sm-2" type="search" name="address" placeholder="Address" aria-label="Address" value="{{ address }}">
    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
  </form>
</nav>
<div id="mynetwork"></div>
  <script>
    // provide data in the DOT language
    var DOTstring = {{ dot | safe }};
    DOTstring = DOTstring.replaceAll('\\l', '\n');
    DOTstring = DOTstring.replaceAll('\\"', '');
    var parsedData = vis.parseDOTNetwork(DOTstring);

    var data = {
      nodes: parsedData.nodes,
      edges: parsedData.edges
    }

    //var options = parsedData.options;
    const options = {
      layout: {
	hierarchical: {
	  enabled: true,
	  levelSeparation: 150,
	},
      },
      physics: {
	hierarchicalRepulsion: {
	  nodeDistance: 150,
	},
      },
    };

    // you can extend the options like a normal JSON variable:

    var level = {}
    if (data.edges.length)
      level[data.edges[0].from] = 0;
    var maxLevel = 0;
    for (i in data.edges) {
      edge = data.edges[i];
      if (!(edge.to in level)) {
	if (!(edge.from in level)) {
	  level[edge.from] = maxLevel;
	}
	level[edge.to] = level[edge.from] + 1;
	maxLevel = (level[edge.to] > maxLevel) ? level[edge.to] : maxLevel;
	maxLevel = level[edge.to];
      }
    }

    for (i in data.nodes) {
      node = data.nodes[i];
      node.color = {
	border: "#000000",
	background: "#FFFFFF",
	highlight: {
	  border: "#28a745",
	  background: "#FFFFFF",
	},
      };
      node.font = { face: "monospace", align: "left" };
      node.level = level[node.id];
      node.label = node.id;
    }

    // create a network
    var container = document.getElementById("mynetwork");
    var network = new vis.Network(container, data, options);

  </script>
<div id="cfg">
</div>
<div class="container bg-light">
  <div class="row border">
    <div id="disasm" class="col">
      disasm
    </div>
    <div class="col">
      <div class="row">
	<div class="col">
	  Context form
	  <div class="form-group row">
	    <label for="userCtx" class="col-sm-2 col-form-label">Context</label>
	    <div class="col-sm-10">
	      <input type="text" class="form-control" id="userCtx" placeholder="Context">
	    </div>
	  </div>
	</div>
      </div>
      <div class="row">
	<div id="cpustate" class="col">
	  state
	</div>
      </div>
      <div class="row">
	<div id="loading" class="col">
	  loading
	</div>
      </div>
    </div>
  </div>
  <div class="row border-left border-right border-top">
    <div class="col">
      Relationship form
      <div class="form-group row">
	<label for="relationAddr" class="col-sm-2 col-form-label">Address</label>
	<div class="col-sm-10">
	  <input type="text" class="form-control" id="relationAddr" placeholder="Address">
	</div>
      </div>
      <div class="form-group row">
	<label for="relationCtx" class="col-sm-2 col-form-label">Context</label>
	<div class="col-sm-10">
	  <input type="text" class="form-control" id="relationCtx" placeholder="Context">
	</div>
      </div>
      <div class="form-group row">
	<div class="col-sm-10">
	  <button onclick="prepareRelationship()" class="btn btn-primary">Show relationship</button>
	</div>
      </div>
    </div>
  </div>
  <div class="row border-left border-right">
    <div id="relationship" class="col">
      Relationship
    </div>
  </div>
  <div class="row border">
    <div class="col">
      Constraint form
      <div class="form-group row">
	<label for="constraintCtx" class="col-sm-2 col-form-label">Constraint</label>
	<div class="col-sm-10">
	  <input type="text" class="form-control" id="constraintCtx" placeholder="Constraint">
	</div>
      </div>
      <div class="form-group row">
	<div class="col-sm-10">
	  <button onclick="prepareConstraint()" class="btn btn-primary">Set constraint</button>
	</div>
      </div>
    </div>
  </div>
</div>


<script>

var treeData =
  {{ block_info | safe }}

// Set the dimensions and margins of the diagram
var margin = {top: 20, right: 90, bottom: 30, left: 90},
    width = 4096 - margin.left - margin.right,
    height = 2048 - margin.top - margin.bottom;

// append the svg object to the body of the page
// appends a 'group' element to 'svg'
// moves the 'group' element to the top left margin
var svg = d3.select("#cfg").append("svg")
    .attr("width", width + margin.right + margin.left)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate("
          + margin.left + "," + margin.top + ")");

var i = 0,
    duration = 750,
    root;

// declares a tree layout and assigns the size
var treemap = d3.tree().size([height, width]);

// Assigns parent, children, height, depth
root = d3.hierarchy(treeData, function(d) { return d.children; });
root.x0 = height / 2;
root.y0 = 0;

// Collapse after the second level
// root.children.forEach(collapse);

update(root);

let cpustateCnt = -1;
let relationshipCnt = -1;

setInterval(function(){
  blocks = data.nodes.map(function (i){return i['id']}).join('_');
  $.post("/bitmap/get", {"blocks": blocks}, function(data, status){
    showBitmap(data["bitmap"]);
    if (cpustateCnt != data["cpustate_cnt"]) {
      showCPUState(data["cpustate"]);
      cpustateCnt = data["cpustate_cnt"];
    }
    if (relationshipCnt != data["relationship_cnt"]) {
      showRelationship(data["relationship"]);
      relationshipCnt = data["relationship_cnt"];
    }
  });
}, 1000);

</script>
</body>
